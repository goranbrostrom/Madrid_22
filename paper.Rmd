---
title: "A biometric analysis of infant mortality and temperature, northern Sweden 1895-1950"
author: "Göran Broström and Tommy Bengtsson"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    citation_package: natbib
    keep_tex: yes
    number_sections: yes
    toc: no
    toc_depth: 2
  bookdown::word_document2:
    toc: no
    toc_depth: 2
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
citation_package: natbib
classoption: titlepage
bibliography: bio.bib
titlepage: yes
biblio-style: apalike
documentclass: article
fontsize: 11pt
header-includes:
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
abstract: "The effect of extreme temperatures on infant mortality in the Umeå region 1895-1950 is studied in a biometric analysis setting."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path='figs/',fig.height=4,comment=NA)
library(knitr)
library(eha)
g <- function(x) (log(1 + x))^3 # x in days.
ginv <- function(y) exp(y^(1/3)) - 1
```

# Introduction

The impact of ambient temperature variations on infant mortality is studied for 
a northern Sweden coastal area, the Umeå and Skellefteå regions, during the 
first half of the twentieth century. Two recent papers [@junkka; @karlsson] studied 
neonatal mortality and climate variations in the same geographical area during the 
years 1880--1950. Climate and mortality in general is a research area that has 
generated great interest over the last years, see @tbgb10.

The effect of seasonal variation and the occurrence of extreme monthly temperatures
is studied and interacted with sex, social class, and legitimacy. Studies are performed 
separatelyfor neonatal  and post-neonatal mortality, and for winter and summer seasons, 
and in a joint analysis, the classification into endogenous and exogenous factors will be discussed.

# The Bourgeouis-Pichat model and the approximation

A variation of the Bourgeouis-Pichat (B-P) biometric analysis [@bp51a;
@bp51b] of infant mortality is suggested. B-P suggests that mortality
during the last eleven months of infancy follows a *uniform* distribution
given a specific transformation of time (age), the 
*log-cube ("BP") transformation*. We show the BP transformation is closely approximated by
an *exponential distribution*, 
that is, the *cumulative hazards function* is linear.
 The advantage is that estimation of exogeneous and
endogeneous infant mortality is easily performed with standard survival
analysis programs.

Central in the *Bourgeouis-Pichat (B-P)* model is the *log-cube* time transform $g$:

\begin{equation*}\label{eq:g}
g(t) = \log^3(1 + t), \quad 0 \le t \le 365,
\end{equation*}

where $t$ is age measured in *days*. 
Its graph is shown in Figure \@ref(fig:figgraph).

```{r figgraph, fig.cap = "The log-cube transform g."}
##g <- function(x) (log(1 + x))^3  # Note: days!
x <- seq(0, 365, length = 1000)
y <- g(x)
plot(x, y, type = "l", xlab = "age (days)", ylab = "g(age)", axes = FALSE, col = "blue")
xat <- c(0, 28, 183, 365)
yat <- g(xat)
axis(1, at = xat)
axis(2, at = yat, labels = round(yat, 1), las = 1)
box()
lines(c(28, 28), c(0, g(28)), lty = 2, col = "darkgreen")
lines(c(0, 28), c(g(28), g(28)), lty = 2, col = "darkgreen")
##
lines(c(183, 183), c(0, g(183)), lty = 2, col = "darkgreen")
lines(c(0, 183), c(g(183), g(183)), lty = 2, col = "darkgreen")
##
lines(c(365, 365), c(0, g(365)), lty = 2, col = "darkgreen")
lines(c(0, 365), c(g(365), g(365)), lty = 2, col = "darkgreen")
abline(h = 0, v = 0)
##abline(a = 0, b = 1, col = "red")
```

The B-P model specifies that, on the transformed age scale, the *exogeneous*
mortality distribution, conditional on death before age 365 days,  is *uniform*, that is, the 
survivor function of $T$ is *linear*.

\begin{equation}
S(t) = 1 - \alpha t, \, 0 < t < g(1).
\end{equation}

Furthermore, it is assumed that the *endogeneous* component is non-zero only during the first
month of life.

It seems to fit infant mortality data very well, but one drawback with it is that the 
uniform distribution is not easy to work with in a survival analysis context.

However, we show that the BP transformation is well approximated by a model where the 
*cumulative hazards function* is linear instead, that is, an *exponential distribution*,
easy to use in standard survival regression analysis, often allowing for massive data reduction
through the statistical *sufficency pinciple*. 

# Data 

## Infant Mortality

```{r readdata}
infdat <- readRDS("data/infdat3.rds")
```

From the Umeå-Skellefteå region, we follow all persons born in the 
region 1895--1950 until death, reaching the age of 1 year, or leaving follow-up for whatever 
reason, whichever comes first. The first few lines (infants) are shown in Table 
\@ref(tab:infdat3).

```{r infdat3}
source("R/tbl.R")
sinf <- infdat[, c("subreg", "sex", "birthdate", "exit", "event")]
x <- head(infdat, 5)
tbl(x, caption = "A few infants in the data set.")
```


### The Bourgeois-Pichat procedure

The BP procedure consists of two steps, to begin with:

1.   Apply the log-cube transformation to the age data, and

2.   plot the cumulative sum of the number of deaths vs. age.

The result is shown in Figure \@ref(fig:ggplot2), with the original, untransformed
data together with the transform, stretched to 365.

```{r ggplot2, fig.cap = "BB plots with and without time transform, Umeå-Skellefteå 1895-1950.", fig.height = 5}
nbths <- NROW(infdat)
##oldpar <- par(mfrow = c(2, 1))
sur <- with(infdat, Surv(enter, exit, event))
rs <- risksets(sur)
ss <- cumsum(rs$n.events)
## Natural:
xt <- rs$risktimes
att <- c(0, 28, 183, 365)
plot(xt, ss / nbths, ylim = c(0, max(ss / nbths)), type = "l",
     axes = FALSE, col = "blue", lwd = 2, xlab = "Age (days)",
     ylab = "Cum. deaths")
abline(h = 0)
axis(2, las = 1)
axis(1, at = att, labels = att)
box()
## g-transformed:
lines(g(xt) / g(365) * 365, ss / nbths, ylim = c(0, max(ss / nbths)), type = "l",
     col = "red", lwd = 2, xlab = "Age (days)",
     main = "After g-transform", ylab = "Cum. deaths")
##abline(h = 0)
##axis(2, las = 1)
axis(3, at = g(att) / g(365) * 365, labels = att, col = "red")
box()
abline(v = 0)
abline(v = g(c(28, 183, 365)) / g(365) * 365, col = "red", lty = 3)
abline(v = c(28, 183, 365), col = "blue", lty = 3)
##
legend("bottomright", legend = c("Natural", "g-transform"), col = c("blue", "red"), lty = 1)
abline(h = (ss / nbths) [28], lty = 3 )
abline(h = (ss / nbths) [180], lty = 3 )
##par(oldpar)
```

The plot, disregarding the transform, is just a graph of the empirical *cumulative distribution function (CDF)*,
that is, one minus the *Kaplan-Meier estimate* of the *survivor function*.

### Post-neonatal mortality

We begin by studying mortality after age 28 days on the g-scale, BP predicts that it is approximately *uniform*. 
The uniform distribution, however, is not very useful in a survival analysis context, so we will
investigate a close alternative, the *exponential * distribution. Modifying the BP plot by using successive 
divison by *risk set size* instead of sample size should result in an approximately linear graph if the 
exponential assumption is valid.

```{r pneo, fig.cap = "Relation between cumulative hazards and CDF for transformed post-neonatal mortality data."}
ginfdat <- age.window(infdat, c(28, 365))
ginfdat$enter <- g(ginfdat$enter)
ginfdat$exit <- g(ginfdat$exit)
grs <- risksets(with(ginfdat, Surv(enter, exit, event)), members = FALSE)
fit <- coxreg(Surv(enter, exit, event) ~ 1, data = ginfdat)
ser <- plot(fit, fn = "sur", fig = FALSE)
##plot(fit, col = "blue", axes = FALSE)
cum <- fit$hazards[[1]]
x <- cum[, 1]
ch <- cumsum(cum[, 2])
plot(x, ch, type = "s", axes = FALSE, col = "blue", xlab = "Age (days)", ylab = "")
axis(1, at = c(g(28), g(183), g(365)), labels = c(28, 183, 365))
axis(2, las = 1)
abline(h = 0)
box()
x <- ser[[1]][[1]][, 1]
y <- ser[[1]][[1]][, 2]
lines(x, 1 - y, col = "red", lty = 2)
legend("topleft", legend = c("Cumulative hazards", "CDF (Bourgeouis-Pichat)"), col = c("blue", "red"),
       lty = c(1, 2))
```

As is evident from Figure \@ref(fig:pneo), the difference between the the two curves is
negligible, and both are well approximated by a straight line, so we will from now on work with the 
assumption that the transformed post-neonatal data are *exponentially distributed*.
There is also a mathematical argument motivating the similarity: The cdf for an exponentially 
distributed random variable $T$ is

\begin{equation*}
F_T(t) = 1 - \exp(-\lambda t), \quad t, \lambda > 0, 
\end{equation*}

and the first order approximation of this cdf is

\begin{equation*}
F_T(t) \approx \lambda t, \quad t, \lambda > 0,
\end{equation*}

which is the *cumulative hazards* function of $T$,
and the approximation is good for small values of $\lambda t$.

So, the *hazard function* (which is the slope of the lines in Figure \@ref(fig:pneo))
is simply estimated by the ratio of the number of deaths to the total time of exposure:

```{r simpest, echo = TRUE}
posthaz <- with(ginfdat, sum(event) / sum(exit - enter))
```

which evaluates to `r format(posthaz, digits = 3, scientific = TRUE)`. A small number, but remember
that the time unit is defined on the scale defined by the function $g$ (close to *day*).

### Neonatal mortality

Is the sum of two components, *external* and *internal* causes. According to the *B-P*
theory, the external component is equal to the post-neonatal mortality, which contains 
only an external component. 

We create the neonatal data set by censor all lives at the age 28:

```{r neon, echo = TRUE}
neo <- age.window(infdat, c(0, 28))
neo$enter <- g(neo$enter)
neo$exit <- g(neo$exit)
```

and then fit a piecewise constant hazards model with cutpoints at (0, 1, 2, 4, 8, 12, 18, 24, 30, 35, 39), see 
Figure \@ref(fig:pchneo).

```{r pchneo, fig.cap = "Neonatal hazard function with external component (dashed).", fig.height = 4}
fitneo <- pchreg(Surv(enter, exit, event) ~ 1, data = neo, cuts = c(0,  1, 2, 4, 8, 12, 18, 24, 30, 35, 39))
plot(fitneo, fn = "haz", col = "blue", main = "", xlab = "g(days)")
abline(h = 0, v = 0)
abline(h = posthaz, col = "red", lty = 2)
```

Let us take a closer look at what happens at the end of the neonatal inerval:

```{r pchneo2, fig.cap = "Neonatal hazard function with external component (dashed), right hand tail.", fig.height = 4}
##fitneo <- pchreg(Surv(enter, exit, event) ~ 1, data = neo, cuts = c(0,  1, 2, 4, 8, 12, 18, 24, 30, 39))
plot(fitneo, fn = "haz", col = "blue", main = "", xlab = "g(days)", xlim = c(15, 39))
abline(h = 0, v = 0)
abline(h = posthaz, col = "red", lty = 2)
```

A smooth transition to the post-neonatal mortality.

## Add weather data

Figure \@ref(fig:mortstat) shows the average monthly crude infant mortality, and a clear seasonal pattern is visible.

```{r mortstat, fig.cap = "Crude infant mortality by week of year, Umeå/Skellefteå 1895--1950."}
infdat <- readRDS("data/infdat3_year3.rds")
tid <- toTpch(Surv(enter, exit, event) ~ week, data = infdat, cuts = c(0, 1))
y <- tid$event / tid$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(min(y), max(y)),
     xlab = "Week", ylab = "IMR")
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, las = 1)
abline(h = c(0.05, 0.06, 0.07, 0.08, 0.09), lty = 3)
box()
```

In accordance with the Bourgeouis-Pichat ideas, we group the analyses into two parts, 
*neonatal* (first 28 days) och *postneonatal* mortality (days 29--365).

### Neonatal mortality

The average monthly neonatal mortality is shown in Figure \@ref(fig:neodata).

```{r neodata, fig.cap = "Crude neonatal mortality by week of year, Umeå/Skellefteå 1895--1950."}
neo <- age.window(infdat, c(0, 28 / 365))
tneo <- toTpch(Surv(enter, exit, event) ~ week, data = neo, cuts = c(0, 28 / 365))
y <- tneo$event / tneo$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(min(y), max(y)),
     xlab = "Week", ylab = "IMR")
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, las = 1)
abline(h = c(0.05, 0.06, 0.07, 0.08, 0.09), lty = 3)
box()
```

The seasonal pattern is similar to the one we found above for infant mortality.

## Postneonatal mortality

The average monthly postneonatal mortality is shown in Figure \@ref(fig:pneodata).

```{r pneodata, fig.cap = "Crude postneonatal mortality by week of year, Umeå/Skellefteå 1895--1950."}
pneo <- age.window(infdat, c(28 / 365, 1))
tpneo <- toTpch(Surv(enter, exit, event) ~ week, data = pneo, cuts = c(28 / 365, 1))
y <- tpneo$event / tpneo$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(min(y), max(y)),
     xlab = "Week", ylab = "IMR")
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, las = 1)
abline(h = c(0.04, 0.05, 0.06, 0.07, 0.08, 0.09), lty = 3)
box()
```

The seasonal pattern is once again similar to the one we found for infant mortality.

## Temperature

```{r readtemp}
umetemp <- readRDS("data/umetemp.rds")
bjurtemp <- readRDS("data/bjurtemp.rds")
```

Temperature data are collected from two weather stations, *Umeå* and *Bjuröklubb*
(used with population data from Skellefteå coastal area). Both stations deliver
daily temperature data covering our time period, usually three measures per day, morning,
noon, and evening. Weekly averages are calculated year by year, and deviations from 
the averages of the weekly averages are used as a time-varying *communal covariate*. See Figure 
\@ref(fig:monavgtemp) for the monthly distributions.

```{r monavgtemp, fig.cap="Weekly max and min temperature averages, 1895--1950."}
oldpar <- par(mfrow= c(1, 2))
## Umeå:
umaxavg <- umetemp$emaxtemp[1:52]
uminavg <- umetemp$emintemp[1:52]
plot(1:52, umaxavg, ylim = c(-20, 30), type = "b", col = "red", axes = FALSE,
     xlab = "Week", ylab = "Temperature (C)")
text(17, 27, "Umeå")
axis(1, at = c(1, 10, 29, 43, 52))
axis(2, las = 1)
abline(h = 0)
abline(v = 29, lty = 3)
abline(h = c(-20, -10, 10, 20), lty = 3)
lines(1:52, uminavg, type = "b", col = "blue")
text(8, 11, "max", col = "red")
text(20, -9, "min", col = "blue")
box()
## Skellefteå:
bmaxavg <- bjurtemp$emaxtemp[1:52]
bminavg <- bjurtemp$emintemp[1:52]
plot(1:52, bmaxavg, ylim = c(-20, 30), type = "b", col = "red", axes = FALSE,
     xlab = "Week", ylab = "Temperature (C)")
text(17, 27, "Skellefteå")
axis(1, at = c(1, 10, 29, 43, 52))
axis(2, las = 1)
abline(h = 0)
abline(v = 29, lty = 3)
abline(h = c(-20, -10, 10, 20), lty = 3)
lines(1:52, bminavg, type = "b", col = "blue")
text(8, 11, "max", col = "red")
text(20, -9, "min", col = "blue")
box()
##
par(oldpar)
```


