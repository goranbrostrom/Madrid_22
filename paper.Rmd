---
title: "A biometric analysis of infant mortality and temperature, northern Sweden 1895-1950"
author: "Göran Broström and Tommy Bengtsson"
date: "`r Sys.time()`"
output:
  bookdown::pdf_document2:
    citation_package: natbib
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  bookdown::word_document2:
    toc: no
    toc_depth: 2
  bookdown::html_document2:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
citation_package: natbib
classoption: titlepage
bibliography: bio.bib
titlepage: yes
biblio-style: apalike
documentclass: article
fontsize: 11pt
header-includes:
- \usepackage[utf8]{inputenc}
- \usepackage{graphicx}
- \usepackage{a4wide}
- \usepackage[figuresonly]{endfloat}
- \renewcommand{\efloatseparator}{\mbox{}}
abstract: "The effect of extreme temperatures on infant mortality in the Umeå region 1895-1950 is studied in a biometric analysis setting. More precisely, the effect of climate and weather, measured by temperature, on infant mortality is investigated. It turns out that climate is more important than weather, low average temperatures are more important than temporary dips in temperature. The investigated geographical region is situated too far north for bad effects of high temperatures to show."
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path='figs/',fig.height=3,comment=NA)
library(knitr)
library(eha)
g <- function(x) (log(1 + x))^3 # x in days.
dg <- function(x) (3 * (log(1 + x))^2) / (1 + x)
ginv <- function(y) exp(y^(1/3)) - 1
```

# Introduction

The impact of ambient temperature variations on infant mortality is studied for 
a northern Sweden coastal area, the Umeå and Skellefteå regions, during the 
first half of the twentieth century. Two recent papers [@junkka; @karlsson] studied 
neonatal mortality and temperature variations in a larger geographical area containing 
the present one during the 
years 1880--1950. Climate and mortality in general is a research area that has 
generated great interest over the last years, see @tbgb10.

The effect of seasonal variation and the occurrence of extreme monthly temperatures
is studied and interacted with sex, social class, and legitimacy. Studies are performed 
separately for neonatal  and postneonatal mortality, and for winter and summer seasons, 
and the classification into endogenous and exogenous factors will be discussed.

One important reason for studying neonatal and postneonatal mortality separately is the 
empirical findings by Bourgeois-Pichat [@bp51a;  @bp51b] about endogenous and exogenous 
mortality and the log-cube transform.


# Data

We have two sources of data which we combine into one data set suitable for our purpose.
The first is demographic data obtained from the 
*Centre for Demographic and Ageing Research* (CEDAR, https://cedar.umu.se),
the second is daily temperature measurements obtained from the 
*Swedish Meteorological and Hydrological Institute* (SMHI, https://www.smhi.se). 

## Infant mortality

Individual data with all births between 1 January 1895 and 31 December 1950 in two 
coastal areas of north Sweden, Skellefteå (51560 births) and Umeå (31213 births).
They were followed until death or age 365 days, whichever came first. 
The following *static* characteristics were observed on each child:

**birthdate** Date of birth. 

**sex** Girl or boy.

**exit** Number of days under observation.

**event** Logical, *TRUE* if a death is observed.

**socBranch** Working branch of father (if any).

**socStatus** Social status of family, based on HISCLASS.

**illeg** Mother unmarried?

**parity** Order among siblings.

Some crude statistics about infant, neonatal, and postneonatal mortality are shown in 
Figures.

Figure \@ref(fig:mortstat) shows the average monthly crude infant mortality, and a clear seasonal pattern is visible.

```{r mortstat, fig.cap = "Crude infant mortality by week of year, Umeå/Skellefteå 1895--1950.", fig.height = 4}
infdat <- readRDS("data/infdat3_year3.rds")
tid <- toTpch(Surv(enter, exit, event) ~ week, data = infdat, cuts = c(0, 1))
y <- tid$event / tid$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(0, max(y)),
     xlab = "Week", ylab = "IMR", cex = 0.7, lwd = 1.5)
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, las = 1, at = c(0, 0.03, 0.06, 0.09))
abline(h = c(0.05, 0.07, 0.09, 0.11), lty = 3)
abline(h = 0)
box()
```

The average monthly neonatal mortality is shown in Figure \@ref(fig:neodata).

```{r neodata, fig.cap = "Crude neonatal mortality by week of year, Umeå/Skellefteå 1895--1950.", fig.height = 4}
neo <- age.window(infdat, c(0, 28 / 365))
tneo <- toTpch(Surv(enter, exit, event) ~ week, data = neo, cuts = c(0, 28 / 365))
y <- tneo$event / tneo$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(0, max(y)),
     xlab = "Week", ylab = "NMR", cex = 0.7, lwd = 1.5)
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, las = 1, at = c(0, 0.2, 0.4, 0.6))
abline(h = c(0.3, 0.4, 0.5, 0.6), lty = 3)
abline(h = 0)
box()
```

The seasonal pattern is similar to the one we found above for infant mortality.

The average monthly postneonatal mortality is shown in Figure \@ref(fig:pneodata).

```{r pneodata, fig.cap = "Crude postneonatal mortality by week of year, Umeå/Skellefteå 1895--1950.", fig.height = 4}
pneo <- age.window(infdat, c(28 / 365, 1))
tpneo <- toTpch(Surv(enter, exit, event) ~ week, data = pneo, cuts = c(28 / 365, 1))
y <- tpneo$event / tpneo$exposure
plot(1:52, y, type = "b", col = "blue", axes = FALSE, ylim = c(0, max(y)),
     xlab = "Week", ylab = "PNMR", cex = 0.7, lwd = 1.5)
axis(1, at = c(1, 10, 20, 30, 40, 52))
axis(2, at = c(0, 0.02, 0.04, 0.06), las = 1)
abline(h = c(0.03, 0.04, 0.05, 0.06, 0.07), lty = 3)
abline(h = 0)
box()
```

The seasonal pattern is once again similar to the one we found for infant mortality.
Next, the decline over the years in Figures \@ref(fig:longtrend) and \@ref(fig:ntrend).

```{r longtrend, fig.cap = "Crude IMR by year, Umeå-Skellefteå 1895--1950.", fig.height = 4}
trend <- toTpch(Surv(enter, exit, event) ~ year, data = infdat, cuts = c(0, 1))
y <- trend$event / trend$exposure
par(las = 1)
plot(1895:1951, y, type = "b", col = "blue", ylim = c(0, max(y)), xlab = "Year",
     ylab = "IMR", lwd = 1.5, cex = 0.7)
abline(h = c(0.05, 0.1, 0.15), lty = 3)
abline(h = 0)
```


```{r ntrend, fig.cap = "Crude NMR by year, Umeå-Skellefteå 1895--1950.", fig.height = 4}
ndat <- age.window(infdat, c(0, 28 / 365))
tnda <- toTpch(Surv(enter, exit, event) ~ year, data = ndat, cuts = c(0, 28 / 365))
y <- tnda$event / tnda$exposure
par(las = 1)
plot(1895:1951, y, type = "b", col = "blue", ylim = c(0, max(y)), xlab = "Year",
     ylab = "NMR", lwd = 1.5, cex = 0.7)
abline(h = 0)
abline(h = c(0.2, 0.4, 0.6), lty = 3)
```

## Temperature

```{r readtemp}
umetemp <- readRDS("data/umetemp.rds")
bjurtemp <- readRDS("data/bjurtemp.rds")
```

Temperature data are collected from two weather stations, *Umeå* and *Bjuröklubb*
(used with population data from Skellefteå coastal area). Both stations deliver
daily temperature data covering our time period, usually three measures per day, morning,
noon, and evening. In Table \@ref(tab:typweek), the Umeå data from the week 1--7 January,
1923 is shown.

```{r typweek}
tum <- read.table("~/Forskning/Data/ume_temp.csv", skip = 10, sep = ";", header = TRUE)
source("R/tbl.R")
ww <- tum[70137:(70137 + 20), ]
names(ww) <- c("Date", "Time", "Temperature", "Quality")
tbl(ww, caption = "Raw temperature data from first week of 1923, Umeå.", fs = 10,
    linesep = c("", "", "\\addlinespace"))
```

There are three measurements per day, or 21 per week. In the forthcoming analyses,
the weekly data are summarized in a few measurements, see Table \@ref(tab:cond).

```{r cond}
sh <- umetemp[umetemp$year == 1923 & umetemp$week == 1, ]
tbl(round(sh[, 1:8], 2), caption = "Weekly summarized temperature data: Umeå 1923, first week.", fs = 9)
```



Weekly averages are calculated year by year, and deviations from 
the averages of the weekly averages are used as a time-varying *communal covariate*. See Figure 
\@ref(fig:monavgtemp) for the monthly distributions.

```{r monavgtemp, fig.cap="Weekly max and min temperature averages, 1895--1950.", fig.height = 4}
oldpar <- par(mfrow = c(1, 2))
## Umeå:
umaxavg <- umetemp$emaxtemp[1:52]
uminavg <- umetemp$emintemp[1:52]
plot(1:52, umaxavg, ylim = c(-20, 30), type = "b", col = "red", axes = FALSE,
     xlab = "Week", ylab = "Temperature (C)", cex = 0.6, lwd = 0.7)
text(17, 27, "Umeå")
axis(1, at = c(1, 10, 29, 43, 52))
axis(2, las = 1)
abline(h = 0)
abline(v = 29, lty = 3)
abline(h = c(-20, -10, 10, 20), lty = 3)
lines(1:52, uminavg, type = "b", col = "blue", cex = 0.6, lwd = 0.7)
text(8, 11, "max", col = "red")
text(20, -9, "min", col = "blue")
box()
## Skellefteå:
bmaxavg <- bjurtemp$emaxtemp[1:52]
bminavg <- bjurtemp$emintemp[1:52]
plot(1:52, bmaxavg, ylim = c(-20, 30), type = "b", col = "red", axes = FALSE,
     xlab = "Week", ylab = "Temperature (C)", cex = 0.6, lwd = 0.7)
text(17, 27, "Skellefteå")
axis(1, at = c(1, 10, 29, 43, 52))
axis(2, las = 1)
abline(h = 0)
abline(v = 29, lty = 3)
abline(h = c(-20, -10, 10, 20), lty = 3)
lines(1:52, bminavg, type = "b", col = "blue", cex = 0.6, lwd = 0.7)
text(8, 11, "max", col = "red")
text(20, -9, "min", col = "blue")
box()
##
par(oldpar)
```

Time trends of yearly average temperatures, see Figure 

```{r longterm}
bmtemp <- rbind(umetemp, bjurtemp)
umt <- with(bmtemp, tapply(meantemp, year, mean))
plot(1894:1951, umt, type = "b", col = "blue", xlab = "Year",
     ylab = "Mean temperature", lwd = 1.5, cex = 0.7, ylim = c(0, 7))
abline(h = 0)
abline(h = 1:6, lty = 3)
```

## Mortality and temperature as a communal covariate

The two data sets, mortality and weather, are combined ino one by treating temperature data 
as a communal covariate and incorporate it as such in the mortality data set.


# Statistical modelling

The analyses are performed on the log-cube scale with proportional hazards modelling. Note that
the property of proportional hazards are preserved under a strictly monotone increasing time transform.
However, the estimates of baseline distribution characteristics will change, of course.

We start by performing separate analyses for neonatal and postneonatal mortality. Then we make comparisons.

# Postneonatal mortality

This is the simplest part, because *B-P* predicts that the baseline distribution (given the log-cube
transformation) is *exponential*, that is, the hazard function is *constant*.

```{r postanalske, results='asis'}
source("R/ltx2.R")
infdat$parity <- cut(infdat$parity, c(-2, 1.5, 4.5, 19), labels = c("1", "2-4", "5+"))
infdat$period <- cut(infdat$birthdate, c(1895, 1914, 1935, 1951), dig.lab = 5)
levels(infdat$subreg) <- c("ume", "ske")
infdat$season <- cut(infdat$week, c(-1, 9.5, 22.5, 35.5, 48.5, 52.5), labels = c("winter", "spring", "summer", "fall", "winter"))
infdat$season <- as.factor(infdat$season)
pneo <- age.window(infdat, c(28 / 365, 1))
##
pneo$enter <- g(pneo$enter * 365)
pneo$exit <- g(pneo$exit * 365)
##
pneo$emintemp <- round(pneo$emintemp)
##
tpneo <- toTpch(Surv(enter, exit, event) ~ period + sex + socBranch + socStatus + illeg + parity + 
                    cold 
                + emintemp + season + subreg, 
                data = pneo, cuts = g(c(28, 365)))
##fit2 <- phreg(Surv(enter - g(28), exit - g(28), event) ~ sex + socBranch + socStatus + cold + emintemp, 
  ##           data = pneo, shape = 1)
##fit.pch <- pchreg(Surv(enter, exit, event) ~ sex + socBranch + socStatus + cold + emintemp, 
  ##           data = pneo, cuts = g(c(28, 365)))
tpneo$excessCold <- with(tpneo, -cold * (cold < 0))
fit.tpch <- tpchreg(oe(event, exposure) ~ excessCold + emintemp  +  period + sex + socBranch + socStatus  + 
                        parity + season, 
                    data = tpneo[tpneo$subreg == "ske", ], time = age)
dr <- drop1(fit.tpch, test = "Chisq")
ltx2(fit.tpch, dr = dr, caption = "Postneonatal mortality, Skellefteå. Adjusted for social status and branch, illegitimacy, parity, time period, season, and sub region.", label = "tab:postanalske", keep = 2)
```

The result in Table \@ref(tab:postanalske) shows that *climate* (`emintemp`) is more important than 
*weather* (`cold`). Moreover, no signs of interaction between weather or climate and the rest of 
covariates (not shown).

```{r postanalume, results = 'asis'}
fit.tpch <- tpchreg(oe(event, exposure) ~ excessCold + emintemp + period + sex + socBranch + socStatus + 
                        parity + season, 
                    data = tpneo[tpneo$subreg == "ume", ], time = age)
dr <- drop1(fit.tpch, test = "Chisq")
ltx2(fit.tpch, dr = dr, caption = "Postneonatal mortality, Umeå. Adjusted for social status and branch, illegitimacy, parity, time period, season, and subregion.", label = "tab:postanalume", keep = 2)
```


# Neonatal mortality

It turns out that here we have some significant interactions, with `sex` involved.
Maybe surprising. So we run separate analyses for the sexes.

## Girls

```{r neoanal, results = 'asis'}
##library(survival)
neo <- age.window(infdat, c(0, 28 /365))
neo$exit <- g(neo$exit * 365)
neo$enter <- g(neo$enter * 365)
fit.ph <- coxreg(Surv(enter, exit, event) ~  cold + emintemp + socStatus + illeg + parity + period + socBranch + subreg,
                 data = neo[neo$sex == "girl", ])
dr <- drop1(fit.ph, test = "Chisq")
ltx2(fit.ph, dr = dr, caption = "Neonatal mortality, girls. Adjusted for social status and branch, illegitimacy, parity, time period, and sub region.", label = "tab:neonatal", keep = 2)
```

Same here, *climate* is more important than *weather*.

## Boys

```{r neoanalboys, results = 'asis'}
fit.ph <- coxreg(Surv(enter, exit, event) ~  cold + emintemp + socStatus + illeg + parity + period + socBranch + subreg,
                 data = neo[neo$sex == "boy", ])
dr <- drop1(fit.ph, test = "Chisq")
ltx2(fit.ph, dr = dr, caption = "Neonatal mortality, boys. Adjusted for social status and branch, illegitimacy, parity, time period, and sub region.", label = "tab:neonatalboys", keep = 2)
```

Here, however, boys are sensitive to temperatures below average, in addition to the 
sensitivity for cold climate.

# Postneonatal mortality, winter and spring

This is the simplest part, because *B-P* predicts that the baseline distribution (given the log-cube
transformation) is *exponential*, that is, the hazard function is *constant*.

```{r postanalw, results='asis'}
##infdat$parity <- cut(infdat$parity, c(-2, 1.5, 4.5, 19), labels = c("1", "2-4", "5+"))
##levels(infdat$subreg) <- c("ume", "ske")
##infdat$season <- cut(infdat$week, c(-1, 9.5, 22.5, 35.5, 48.5, 52.5), labels = c("winter", "spring", "summer", "fall", "winter"))
##infdat$season <- as.factor(infdat$season)
pneo <- age.window(infdat[infdat$season %in% c("winter", "spring"), ], c(28 / 365, 1))
##
pneo$enter <- g(pneo$enter * 365)
pneo$exit <- g(pneo$exit * 365)
##
pneo$emintemp <- round(pneo$emintemp)
##
tpneo <- toTpch(Surv(enter, exit, event) ~ sex + socBranch + socStatus + illeg + parity + 
                    cold + emintemp + period + subreg, 
                data = pneo, cuts = g(c(28, 365)))
##fit2 <- phreg(Surv(enter - g(28), exit - g(28), event) ~ sex + socBranch + socStatus + cold + emintemp, 
  ##           data = pneo, shape = 1)
##fit.pch <- pchreg(Surv(enter, exit, event) ~ sex + socBranch + socStatus + cold + emintemp, 
  ##           data = pneo, cuts = g(c(28, 365)))
fit.tpch <- tpchreg(oe(event, exposure) ~ cold + emintemp + sex + socBranch + socStatus + illeg + parity + period + 
                        subreg, 
                    data = tpneo, time = age)
dr <- drop1(fit.tpch, test = "Chisq")
ltx2(fit.tpch, dr = dr, caption = "Postneonatal mortality, winter and spring. Adjusted for social status and branch, illegitimacy, parity, time period, and sub region.", 
     label = "tab:postanalw", keep = 2)
```

The result in Table \@ref(tab:postanalw) shows that *climate* (`emintemp`) is more important than 
*weather* (`cold`). Moreover, no signs of interaction between weather or climate and the rest of 
covariates (not shown).

# Neonatal mortality, winter and spring

It turns out that here we have some significant interactions, with `sex` involved.
Maybe surprising. So we run separate analyses for the sexes.

## Girls

```{r neoanalw, results = 'asis'}
neo <- age.window(infdat[infdat$season %in% c("winter", "spring"), ], c(0, 28 /365))
neo$exit <- g(neo$exit * 365)
neo$enter <- g(neo$enter * 365)
fit.ph <- coxreg(Surv(enter, exit, event) ~  cold + emintemp + socStatus + illeg + parity + period + socBranch + subreg,
                 data = neo[neo$sex == "girl", ])
dr <- drop1(fit.ph, test = "Chisq")
ltx2(fit.ph, dr = dr, caption = "Neonatal mortality winter and spring, girls. Adjusted for social status and branch, illegitimacy, parity, time period, and sub region.", label = "tab:neonatalw", keep = 2)
```

Same here, *climate* is more important than *weather*.

## Boys

```{r neoanalboysw, results = 'asis'}
fit.ph <- coxreg(Surv(enter, exit, event) ~  cold + emintemp + socStatus + illeg + parity + period + socBranch + subreg,
                 data = neo[neo$sex == "boy", ])
dr <- drop1(fit.ph, test = "Chisq")
ltx2(fit.ph, dr = dr, caption = "Neonatal mortality winter and spring, boys. Adjusted for social status and branch, illegitimacy, parity, time period, and sub region.", 
     label = "tab:neonatalboysw", keep = 2)
```

Here, however, boys are sensitive to temperatures below average, in addition to the 
sensitivity for cold climate.

# Conclusion

Remains to be written. Feels like two papers, one about Bourgeois-Pichat and one
about climate and weather. Maybe discuss exogeneity/endogeneity?
